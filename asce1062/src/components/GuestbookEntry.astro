---
import type { GuestEntry, EntryStyle } from "@/lib/api/guestbook";
import { formatEntryDate } from "@/lib/api/guestbook";
import EntryActions from "@/components/GuestBookEntryActions.astro";

interface Props {
	entry: GuestEntry;
}

const { entry } = Astro.props;
const formattedDate = formatEntryDate(entry.timestamp);

// Simple ASCII art detection
// Lines with 2+ consecutive spaces
// Normal prose never has double spaces, but ASCII art relies on them for alignment
const isAsciiArt = / {2}/.test(entry.message);

// Parse style JSON with fallback defaults
const defaults: EntryStyle = {
	bg: "topography",
	borderColor: "base-300",
	borderWidth: "1px",
	borderStyle: "solid",
	borderRadius: "0.25rem",
};

let style: EntryStyle = defaults;
if (entry.style) {
	try {
		style = { ...defaults, ...JSON.parse(entry.style) };
	} catch {
		// Invalid JSON. Use defaults
	}
}

// Build inline style string
const inlineStyles = [
	style.bg !== "none" ? `--pattern-url: url(/notecards/${style.bg}.svg)` : null,
	`border-color: var(--color-${style.borderColor})`,
	`border-width: ${style.borderWidth}`,
	`border-style: ${style.borderStyle}`,
	`border-radius: ${style.borderRadius}`,
]
	.filter(Boolean)
	.join("; ");
---

<article class="entry" id={`entry-${entry.id}`}>
	<div class="entry-bubble" style={inlineStyles}>
		<EntryActions
			entryId={entry.id}
			entryName={entry.name}
			entryStyle={entry.style || ""}
			entryMessage={entry.message}
		/>
		<pre class:list={["entry-message", { "entry-message--art": isAsciiArt }]}>{entry.message}</pre>
		<div class="entry-meta">
			<h2>
				{
					entry.url ? (
						<a href={entry.url} target="_blank" rel="noopener noreferrer">
							{entry.name}
						</a>
					) : (
						entry.name
					)
				}
			</h2>
			<time datetime={entry.timestamp.toISOString()}>{formattedDate}</time>
		</div>
	</div>
</article>
