---
import { getLanguageIcon } from "@/lib/utils/languageIcons";
import { getGitHubOgImage } from "@/lib/api/github";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
	name: string;
	url: string;
	repo: string;
	description: string;
	tools: Array<any>;
	stars?: number;
	forks?: number;
	issues?: number;
	contributors?: number;
	fork?: boolean;
	image?: ImageMetadata;
	imagePath?: string; // Base path to search for images (e.g., "/src/assets/projects/projectname")
}

const { name, url, repo, description, tools, stars, forks, issues, contributors, image, imagePath } = Astro.props;

// If imagePath is provided but no image, try to find the image
let resolvedImage = image;
if (!resolvedImage && imagePath) {
	const images = import.meta.glob<{ default: ImageMetadata }>("/src/assets/projects/*.{jpeg,jpg,png,gif}");
	const extensions = [".jpg", ".jpeg", ".png", ".gif"];

	for (const ext of extensions) {
		const fullPath = imagePath + ext;
		if (images[fullPath]) {
			resolvedImage = (await images[fullPath]()).default;
			break;
		}
	}
}

// Generate GitHub OpenGraph fallback URL from repo URL if no local image found
const githubOgUrl = !resolvedImage ? getGitHubOgImage(repo) : null;
---

<div
	class="relative flex flex-col overflow-auto bg-[color-mix(in_oklab,var(--color-neutral)_40%,transparent)] border border-base-300">
	{
		resolvedImage && (
			<Image src={resolvedImage} alt={description} class="w-full h-48 object-cover" loading="lazy" decoding="async" />
		)
	}
	{
		!resolvedImage && githubOgUrl && (
			<img src={githubOgUrl} alt={description} class="w-full h-48 object-cover" loading="lazy" decoding="async" />
		)
	}
	<div class="p-4 h-full flex flex-col gap-2">
		<a
			class="no-underline text-sm transition-all duration-300 font-bold hover:text-primary-content text-warning break-all w-fit font-retro"
			href={url}
			target="_blank"
			rel="noopener noreferrer">
			{name}
		</a>
		<span class="flex flex-row justify-between items-center w-full text-xs sm:text-sm font-bold">
			{
				contributors !== undefined && (
					<span
						class:list={[
							"flex flex-row items-center gap-1 font-retro",
							contributors >= 1 ? "text-warning" : "text-neutral-content",
						]}>
						<i class="icon-repo-contributors" />
						{contributors}
					</span>
				)
			}
			{
				issues !== undefined && (
					<span
						class:list={[
							"flex flex-row items-center gap-1 font-retro",
							issues >= 1 ? "text-warning" : "text-neutral-content",
						]}>
						<i class="icon-issue-opened" />
						{issues}
					</span>
				)
			}
			{
				stars !== undefined && (
					<span
						class:list={[
							"flex flex-row items-center gap-1 font-retro",
							stars >= 1 ? "text-warning" : "text-neutral-content",
						]}>
						<i class="icon-star" />
						{stars}
					</span>
				)
			}
			{
				forks !== undefined && (
					<span
						class:list={[
							"flex flex-row items-center gap-1 font-retro",
							forks >= 1 ? "text-warning" : "text-neutral-content",
						]}>
						<i class="icon-repo-forked" />
						{forks}
					</span>
				)
			}
		</span>
		<div class="grow break-all">
			<p>{description}</p>
		</div>

		<div class="flex flex-col gap-2">
			{
				tools && tools.length > 0 && (
					<div class="flex flex-wrap gap-2">
						{tools.map((tool) => {
							const iconClass = getLanguageIcon(tool.name) || tool.icon;
							return (
								<span class="text-xs sm:text-sm transition-all duration-300 bg-success text-success-content px-2 py-1 font-bold flex items-center gap-1 font-retro">
									{iconClass && <i class={iconClass} />}
									{tool.name}
								</span>
							);
						})}
					</div>
				)
			}
			<div>
				<a
					class="hover:underline hover:decoration-wavy link-action transition-colors"
					href={repo}
					target="_blank"
					rel="noopener noreferrer"
					aria-label={`Visit the GitHub repository for ${name}`}>
					<i class="icon-github"></i> view source
				</a>
			</div>
		</div>
	</div>
</div>
