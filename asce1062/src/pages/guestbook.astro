---
export const prerender = false;

import Layout from "@/layouts/Layout.astro";
import PreviewImage from "@/components/PreviewImage.astro";
import PrivacyPolicy from "@/components/PrivacyPolicy.astro";
import GuestbookEntry from "@/components/GuestbookEntry.astro";
import ShareNotification from "@/components/ShareNotification.astro";
import Expand from "@/components/ui/Expand.astro";
import { getGuestEntries, createGuestEntry } from "@/lib/api/guestbook";
import { patterns, swatchColors, radiusValues, borderStyles, toTitleCase } from "@/config/guestbook";
import "@/styles/components/guestbook.css";

const image = "/src/assets/guestbook/guestbook.png";
const title = "Guestbook";
const description = "Drop me a note, let's connect ^^";

if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const name = formData.get("name") as string;
	const email = formData.get("email") as string;
	const url = formData.get("url") as string;
	const message = formData.get("message") as string;
	const style = formData.get("style") as string;
	const honeypot = formData.get("bot-field");

	if (
		!honeypot &&
		typeof name === "string" &&
		typeof message === "string" &&
		name.trim().length > 0 &&
		message.trim().length > 0
	) {
		await createGuestEntry({ name, email, url, message, style });
		return Astro.redirect("/success");
	}
}

const entries = await getGuestEntries();
---

<Layout title={title} ogImage="social-preview.png" description={description}>
	<PreviewImage src={image} altText={title} />
	<h1>{title}</h1>
	<p>{description}</p>
	<p>
		In the spirit of the beautifully chaotic, handcrafted web of yesteryear â€” when we all had personal homepages filled
		with <span class="blink">blinking text</span>, dubious counters <strong>
			Visitor# <span id="counter">000000</span>
		</strong>, way too many <marquee>marquee tags</marquee> and
		<span class="faded-text">color faded text (not just to impress recruiters)</span>, I've decided to bring back the
		classic guestbook.
	</p>
	<p>
		Just keep in mind:
		<ul>
			<li>Messages appear instantly, no waiting for the next time I ship an update.</li>
			<li>All messages are subject to moderation and may be removed after the fact.</li>
			<li>Be kind. Spam and abuse will be removed.</li>
		</ul>
		<form id="form" method="POST">
			<p>
				<label>
					Name
					<br /><input class="input-allowed" type="text" name="name" required />
				</label>
			</p>
			<p>
				<label>
					Email <small>(optional, not published)</small>
					<br /><input class="input-allowed" type="email" name="email" />
				</label>
			</p>
			<p>
				<label>
					URL <small>(optional, linked from Name)</small>
					<br /><input
						class="input-allowed"
						type="url"
						name="url"
						placeholder="https://example.com"
						pattern="https://.*"
					/>
				</label>
			</p>
			<p>
				<label>
					Subject <small>(please <b>skip</b> this field if you're real)</small>
					<br /><input class="input-honeypot" type="text" name="bot-field" placeholder="Leave me be!" />
					<small>Are you sure you want to type in here? <b>I won't get your message</b>!</small>
				</label>
			</p>
			<p>
				<label class="message" for="message-textarea"> Message </label>
			</p>

			<input type="hidden" id="style-input" name="style" />

			<div class="mb-4 max-w-[380px]">
				<Expand title="Customize your card" id="customizer-panel">
					<div slot="content" class="p-4">
						<!-- Background Pattern -->
						<div class="customizer-section">
							<h4>Background Pattern</h4>
							<div class="customizer-row">
								<select id="pattern-select" class="input-allowed pattern-select">
									<option value="none">None</option>
									{patterns.map((p) => <option value={p}>{toTitleCase(p)}</option>)}
								</select>
								<div id="pattern-swatch" class="pattern-swatch"></div>
							</div>
						</div>

						<!-- Border Radius -->
						<div class="customizer-section">
							<h4>Border Radius</h4>
							<div class="flex gap-2">
								{
									radiusValues.map((r) => (
										<div
											class="option-card rounded-field bg-base-200 hover:bg-base-300 cursor-pointer overflow-hidden transition-colors"
											data-radius={r}
											title={r}>
											<div class="pe-3 pt-2">
												<div
													class="h-6 w-8 border-e-2 border-t-2 border-base-content/20"
													style={`border-start-end-radius: ${r}`}
												/>
											</div>
										</div>
									))
								}
							</div>
						</div>

						<!-- Border Width -->
						<div class="customizer-section">
							<h4>Border Width</h4>
							<div class="relative mt-6 mb-1">
								<kbd
									id="border-width-label"
									class="kbd kbd-sm absolute bottom-full mb-1 -translate-x-1/2 text-[0.625rem]"
									style="left: calc(14.29% + 0.446rem);">1px</kbd
								>
								<input
									id="border-width-slider"
									type="range"
									min="0"
									max="7"
									step="1"
									value="1"
									class="w-full h-2 rounded-full appearance-none cursor-pointer bg-base-300 range-styled"
								/>
							</div>
						</div>

						<!-- Border Color -->
						<div class="customizer-section">
							<h4>Border Color</h4>
							<div class="customizer-row">
								{
									swatchColors.map((c) => (
										<div class="color-swatch" data-border-color={c} style={`background-color: var(--color-${c})`} />
									))
								}
							</div>
						</div>

						<!-- Border Style -->
						<div class="customizer-section">
							<h4>Border Style</h4>
							<div class="flex gap-2">
								{
									borderStyles.map((s) => (
										<div
											class="option-card rounded-field bg-base-200 hover:bg-base-300 cursor-pointer overflow-hidden transition-colors"
											data-border-style={s}
											title={s}>
											<div class="pe-3 pt-2">
												{s === "none" ? (
													<div class="h-6 w-8 flex items-center justify-center text-base-content/40">
														<i class="icon-x-lg -mt-1 -ml-1" />
													</div>
												) : (
													<div
														class="h-6 w-8 border-e-2 border-t-2 border-base-content/20"
														style={`border-style: ${s}; border-start-end-radius: 0.25rem${s === "double" ? "; border-block-start-width: 4px; border-inline-end-width: 4px" : ""}`}
													/>
												)}
											</div>
										</div>
									))
								}
							</div>
						</div>

						<div class="flex justify-end mb-4">
							<button type="button" id="customizer-done" class="btn btn-neutral">
								<i class="font-retro">Done</i>
							</button>
						</div>
					</div>
				</Expand>
			</div>

			<div class="mb-4">
				<button
					type="button"
					id="customizer-random"
					class="h-7 w-7 md:h-8 md:w-8 rounded-md transition-all duration-100 hover:text-accent hover:rotate-6 cursor-pointer">
					<i class="icon-magic text-lg"></i>
				</button>
			</div>

			<div id="textarea-wrapper" class="textarea-wrapper">
				<!-- prettier-ignore-start -->
				<textarea
					id="message-textarea"
					name="message"
					rows="4"
					required
					class="block p-2.5 w-full text-sm textarea-styled"
					placeholder="Say hi, write a poem, or sketch some ASCII art..."></textarea>
				<!-- prettier-ignore-end -->
			</div>

			<p>
				<label class="consent">
					<input type="checkbox" required /><small>
						I consent to this message being stored in a self-hosted database with honeypot and pattern-based spam
						filtering.
					</small>
				</label>
			</p>
			<p>
				<button type="submit" class="btn btn-success"
					><span class="font-retro text-success-content">Sign Guestbook</span>
				</button>
			</p>
		</form>
		<PrivacyPolicy />
		{entries.map((entry) => <GuestbookEntry entry={entry} />)}
	</p>
	<ShareNotification id="entry-action-notification" message="Copied!" />
</Layout>

<script>
	import { initGuestbookCounter } from "@/scripts/guestbookCounter";
	import { initGuestbookCustomizer } from "@/scripts/guestbookCustomizer";
	import { initEntryActions } from "@/scripts/guestbookEntryActions";
	import { initShareNotification } from "@/scripts/shareManager";

	function initGuestbook() {
		initGuestbookCounter();
		initGuestbookCustomizer();
		initEntryActions();
		// Guard: notification element may not exist during view transition navigation
		if (document.getElementById("entry-action-notification")) {
			initShareNotification("entry-action-notification");
		}
	}

	document.addEventListener("astro:page-load", initGuestbook);
</script>
