---
import Layout from "@/layouts/Layout.astro";
---

<Layout title="Offline" ogImage="social-preview.png" description="You are currently offline">
	<div class="flex flex-col items-center justify-center min-h-[60vh] text-center">
		<h1 class="text-4xl font-bold mb-4 font-retro">You're Offline</h1>
		<p class="text-xl mb-8">
			It looks like you've lost your internet connection.<br />
			Don't worry, you can still browse cached pages!
		</p>
		<div id="offline-status" class="mb-4 text-sm opacity-70"></div>
		<div class="flex flex-col sm:flex-row gap-4">
			<button id="retry-btn" class="link-action link-action--primary no-underline">
				<i class="icon-arrow-clockwise text-2xl"></i>Try Again
			</button>
			<a href="/" class="link-action link-action--secondary no-underline">
				<i class="icon-house-heart text-2xl"></i>Go to Home
			</a>
		</div>
	</div>
</Layout>

<script>
	import { OfflineManager } from "@/scripts/offlineManager";

	const statusEl = document.getElementById("offline-status");
	const retryBtn = document.getElementById("retry-btn");

	// Save the referrer as the last page if available
	if (document.referrer && document.referrer !== window.location.href) {
		OfflineManager.saveLastPage(document.referrer);
	}

	// Update status display
	function updateStatus(online: boolean) {
		if (statusEl) {
			if (online) {
				statusEl.textContent = "Connection restored! Redirecting...";
			} else {
				statusEl.textContent = "You are currently offline";
			}
		}
	}

	// Redirect handler shared by all recovery paths
	function handleConnectionRestored() {
		updateStatus(true);
		setTimeout(() => {
			OfflineManager.tryRedirectToLastPage();
		}, 1000);
	}

	// Manual retry button
	retryBtn?.addEventListener("click", () => {
		window.location.reload();
	});

	// Listen for online/offline events
	OfflineManager.setupListeners(
		() => handleConnectionRestored(),
		() => updateStatus(false)
	);

	// Periodic server polling (every 2.5s) as fallback for unreliable online event
	OfflineManager.startPolling(() => handleConnectionRestored());

	// Show initial status
	updateStatus(OfflineManager.isOnline());
</script>
