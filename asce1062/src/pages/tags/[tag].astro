---
import Layout from "@/layouts/Layout.astro";
import Post from "@/components/Post.astro";
import Columns from "@/components/ui/Columns.astro";
import { getCollection } from "astro:content";
import { sortPostsByDate, getAllTags, getPostUrl, formatPostDate, estimateReadingTime } from "@/lib/blog/utils";

export async function getStaticPaths() {
	const allPosts = await getCollection("blog");
	const sortedPosts = sortPostsByDate(allPosts);
	const uniqueTags = getAllTags(allPosts);
	return uniqueTags.map((tag: string) => {
		const filteredPosts = sortedPosts.filter((post) => post.data.tags.includes(tag));
		return {
			params: { tag },
			props: { posts: filteredPosts },
		};
	});
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout
	title={tag}
	ogImage="social-preview.png"
	description=`bleep bloop found ${posts.length} ${ posts.length == 1 ? "post" : "posts"}`>
	<div class="flex flex-col gap-4">
		<p>found {posts.length} {posts.length == 1 ? "post" : "posts"} tagged with <b>{tag}</b></p>
		<Columns columns={1}>
			{
				posts.map((post) => (
					<Post
						name={post.data.title}
						url={getPostUrl(post.id)}
						image={post.data.image.url}
						description={post.data.description}
						date={formatPostDate(post.data.pubDate, "short")}
						tags={post.data.tags}
						readingTime={estimateReadingTime(post.body)}
					/>
				))
			}
		</Columns>
	</div>
</Layout>
