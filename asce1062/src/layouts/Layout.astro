---
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import BackToTop from "@/components/BackToTop.astro";
import FloatingSearch from "@/components/FloatingSearch.astro";
import MetaTags from "@/components/seo/MetaTags.astro";
import OpenGraphTags from "@/components/seo/OpenGraphTags.astro";
import Themes from "astro-themes";
import { ClientRouter } from "astro:transitions";
import { pwaInfo } from "virtual:pwa-info";
import "@/styles/global.css";
import { SITE, SEO, getPageTitle } from "@/config/site-config";

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	type?: "website" | "article";
	datePublished?: string;
	dateModified?: string;
	tags?: string[];
	category?: string;
	readingTime?: string;
	/** Set to true to add noindex, nofollow to the page */
	noIndex?: boolean;
}

const {
	title,
	description,
	ogImage,
	type,
	datePublished,
	dateModified,
	tags,
	category,
	readingTime,
	noIndex = false,
} = Astro.props;

// Safe base URL fallback: use Astro.site if configured, otherwise fall back to SITE.url
const base = Astro.site ?? new URL(SITE.url);
const permalink = new URL(Astro.url.pathname, base).href;
const ogImageURL = ogImage ? new URL(ogImage, base).href : undefined;
const rssURL = new URL("rss.xml", base).href;

const pageDescription = description ?? SITE.description;
const pageTitle = getPageTitle(title);
---

<!doctype html>
<html lang={SEO.language} class="h-min md:min-h-dvh">
	<head>
		<ClientRouter />
		<MetaTags
			title={pageTitle}
			description={pageDescription}
			canonical={permalink}
			rssUrl={rssURL}
			generator={Astro.generator}
			noIndex={noIndex}
		/>
		<OpenGraphTags
			title={pageTitle}
			description={pageDescription}
			url={permalink}
			image={ogImageURL}
			type={type}
			datePublished={datePublished}
			dateModified={dateModified}
			tags={tags}
			category={category}
			readingTime={readingTime}
		/>

		<link href="/css/style.css" rel="stylesheet" />
		<Themes defaultTheme="dark" />

		<!-- PWA Manifest -->
		{pwaInfo && <link rel="manifest" href={pwaInfo.webManifest.href} />}

		<!-- Service Worker Registration (Production Only) -->
		<script is:inline define:vars={{ isProd: import.meta.env.PROD }}>
			// Only register service worker in production to avoid 404 errors in development
			if ("serviceWorker" in navigator && isProd) {
				navigator.serviceWorker.register("/sw.js", { scope: "/" }).catch((error) => {
					console.error("Service Worker registration failed:", error);
				});
			}
		</script>

		<style is:global>
			body {
				visibility: visible;
				opacity: 1;
				transition:
					visibility 0.2s linear,
					opacity 0.2s linear;
			}

			/* Skip to main content link accessibility styles */
			.skip-link {
				position: absolute;
				top: -40px;
				left: 0;
				background: var(--color-base-100);
				color: var(--color-base-content);
				padding: 8px 16px;
				text-decoration: none;
				border-radius: 0 0 4px 0;
				z-index: 100;
			}

			.skip-link:focus {
				top: 0;
			}
		</style>
	</head>

	<body
		class="z-1 m-0 min-w-full h-min md:min-h-dvh flex flex-col items-center bg-base-100 bg-[url('/topographylight.svg')] dark:bg-[url('/topography.svg')] font-proto text-base-content">
		<!-- Skip to main content link for accessibility -->
		<a href="#main-content" class="skip-link">Skip to main content</a>
		<div
			id="primary"
			class="z-2 w-full content-prose m-auto p-4 md:p-8 relative grow flex flex-col min-h-dvh transition-all duration-100 lg:w-1/2">
			<Header />
			<!-- https://docs.astro.build/en/guides/view-transitions/#built-in-animation-directives -->
			<main id="main-content" class="grow" transition:animate="fade">
				<slot />
			</main>
			<Footer />
		</div>
		<!-- Global floating back to top button -->
		<BackToTop />
		<!-- Global floating search modal -->
		<FloatingSearch />
	</body><!-- Global scroll progress initialization -->
	<script>
		import { initScrollProgress } from "@/scripts/scrollProgress";

		// Initialize on first load
		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initScrollProgress);
		} else {
			initScrollProgress();
		}

		// Reinitialize after view transitions
		document.addEventListener("astro:page-load", initScrollProgress);
	</script>
</html>
