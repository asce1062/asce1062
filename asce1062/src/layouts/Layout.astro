---
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import BackToTop from "@/components/BackToTop.astro";
import MetaTags from "@/components/seo/MetaTags.astro";
import OpenGraphTags from "@/components/seo/OpenGraphTags.astro";
import Themes from "astro-themes";
import { ClientRouter } from "astro:transitions";
import { pwaInfo } from "virtual:pwa-info";
import "@/styles/global.css";
import { DEFAULT_DESCRIPTION, SITE_TITLE_SUFFIX } from "@/config/site-config";

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	type?: "website" | "article";
	datePublished?: string;
	dateModified?: string;
	tags?: string[];
	category?: string;
	readingTime?: string;
}

const { title, description, ogImage, type, datePublished, dateModified, tags, category, readingTime } = Astro.props;
const permalink = new URL(Astro.url.pathname, Astro.site).href;
const ogImageURL = ogImage ? new URL(ogImage, Astro.site).href : undefined;
const rssURL = new URL("rss.xml", Astro.site);
const pageDescription = description ? description : DEFAULT_DESCRIPTION;
const pageTitle = `${title} - ${SITE_TITLE_SUFFIX}`;
---

<!doctype html>
<html lang="en">
	<head>
		<ClientRouter />
		<MetaTags
			title={pageTitle}
			description={pageDescription}
			canonical={permalink}
			rssUrl={rssURL.href}
			generator={Astro.generator}
		/>
		<OpenGraphTags
			title={pageTitle}
			description={pageDescription}
			url={permalink}
			image={ogImageURL}
			type={type}
			datePublished={datePublished}
			dateModified={dateModified}
			tags={tags}
			category={category}
			readingTime={readingTime}
		/>

		<link href="/css/style.css" rel="stylesheet" />
		<Themes defaultTheme="dark" />

		<!-- PWA Manifest -->
		{pwaInfo && <link rel="manifest" href={pwaInfo.webManifest.href} />}

		<!-- Service Worker Registration (Production Only) -->
		<script is:inline define:vars={{ isProd: import.meta.env.PROD }}>
			// Only register service worker in production to avoid 404 errors in development
			if ("serviceWorker" in navigator && isProd) {
				navigator.serviceWorker.register("/sw.js", { scope: "/" }).catch((error) => {
					console.error("Service Worker registration failed:", error);
				});
			}
		</script>

		<!-- Critical CSS for FOUC (Flash of Unstyled Content) prevention -->
		<style is:inline>
			body {
				visibility: hidden;
				opacity: 0;
			}
		</style>
		<style is:global>
			body {
				visibility: visible;
				opacity: 1;
				transition:
					visibility 0.2s linear,
					opacity 0.2s linear;
			}

			/* Skip to main content link accessibility styles */
			.skip-link {
				position: absolute;
				top: -40px;
				left: 0;
				background: #120f19;
				color: white;
				padding: 8px 16px;
				text-decoration: none;
				border-radius: 0 0 4px 0;
				z-index: 100;
			}

			.skip-link:focus {
				top: 0;
			}
		</style>
	</head>

	<body
		class="z-1 min-w-full min-h-screen flex flex-col items-center mt-6 bg-[#e8e5f0] dark:bg-palette-700 bg-[url('/topographylight.svg')] dark:bg-[url('/topography.svg')] font-proto text-white">
		<!-- Skip to main content link for accessibility -->
		<a href="#main-content" class="skip-link">Skip to main content</a>
		<div
			id="primary"
			class="z-2 w-full prose prose-invert px-4 sm:px-6 md:px-8 mx-auto relative flex-grow flex flex-col min-h-screen">
			<Header />
			<!-- https://docs.astro.build/en/guides/view-transitions/#built-in-animation-directives -->
			<main id="main-content" class="flex-grow" transition:animate="fade">
				<slot />
			</main>
			<Footer />
		</div>
		<!-- Global floating back to top button -->
		<BackToTop />
	</body><!-- Global scroll progress initialization -->
	<script>
		import { initScrollProgress } from "@/scripts/scrollProgress";

		// Initialize on first load
		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", initScrollProgress);
		} else {
			initScrollProgress();
		}

		// Reinitialize after view transitions
		document.addEventListener("astro:page-load", initScrollProgress);
	</script>
</html>
