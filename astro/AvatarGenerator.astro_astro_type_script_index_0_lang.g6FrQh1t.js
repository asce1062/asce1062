import{i as v,c as L}from"./shareManager.CWvGNRdp.js";const d={male:[{name:"face",title:"Face",count:4,zIndex:1},{name:"clothes",title:"Clothes",count:65,zIndex:2},{name:"hair",title:"Hair",count:36,zIndex:3},{name:"eye",title:"Eyes",count:32,zIndex:4},{name:"mouth",title:"Mouth",count:26,zIndex:5},{name:"background",title:"Background",count:21,zIndex:0}],female:[{name:"face",title:"Face",count:4,zIndex:1},{name:"clothes",title:"Clothes",count:59,zIndex:2},{name:"hair",title:"Hair",count:33,zIndex:3},{name:"eye",title:"Eyes",count:53,zIndex:4},{name:"mouth",title:"Mouth",count:17,zIndex:5},{name:"background",title:"Background",count:21,zIndex:0}]},h=(o,e,t)=>e==="background"?`/8bit/img/common/${e}${t}.png`:`/8bit/img/${o}/${e}${t}.png`,w=o=>{const e=d[o],t={};return e.forEach(r=>{t[r.name]=Math.floor(Math.random()*r.count)+1}),t},f=o=>{const e=d[o],t={},a={male:[3,54,12,14,15,21],female:[4,26,32,22,3,3]}[o];return e.forEach((n,s)=>{t[n.name]=a[s]}),t};class C{canvas;ctx;imageCache=new Map;loadingIndicator;isLoading=!1;constructor(e,t){const r=document.getElementById(e);if(!r)throw new Error(`Canvas with id "${e}" not found`);this.canvas=r;const a=this.canvas.getContext("2d");if(!a)throw new Error("Could not get 2D context from canvas");this.ctx=a,this.loadingIndicator=t?document.getElementById(t):null}async preloadImages(e){this.setLoading(!0);const t=d[e],r=[];for(const a of t)for(let n=1;n<=a.count;n++){const s=h(e,a.name,n);this.imageCache.has(s)||r.push(this.loadImage(s))}await Promise.all(r),this.setLoading(!1)}loadImage(e){return new Promise(t=>{const r=new Image;r.onload=()=>{this.imageCache.set(e,r),t()},r.onerror=()=>{console.error(`Failed to load image: ${e}`),t()},r.src=e})}getCachedImage(e){return this.imageCache.get(e)}async renderAvatar(e,t){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const a=[...d[e]].sort((n,s)=>n.zIndex-s.zIndex);for(const n of a){const s=t[n.name],c=h(e,n.name,s),i=this.imageCache.get(c);i&&i.complete&&this.ctx.drawImage(i,0,0,this.canvas.width,this.canvas.height)}}renderThumbnail(e,t,r,a,n=80,s=80){const c=document.createElement("canvas");c.width=n,c.height=s;const i=c.getContext("2d");if(t!=="background"){const p=h(e,"background",a),u=this.imageCache.get(p);u&&u.complete&&i.drawImage(u,0,0,n,s)}const l=h(e,t,r),g=this.imageCache.get(l);return g&&g.complete&&i.drawImage(g,0,0,n,s),c}downloadAvatar(e="8biticon.png"){this.canvas.toBlob(t=>{if(!t)return;const r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)},"image/png")}setLoading(e){this.isLoading=e,this.loadingIndicator&&this.loadingIndicator.classList.toggle("hidden",!e)}getIsLoading(){return this.isLoading}}class b{currentGender;currentState;currentLayer;genderRadios;onStateChange;constructor(e="male"){this.currentGender=e,this.currentState=f(this.currentGender),this.currentLayer=d[this.currentGender][0].name,this.genderRadios=document.querySelectorAll('input[name="gender"]'),this.loadFromURL()}getGender(){return this.currentGender}getState(){return this.currentState}getCurrentLayer(){return this.currentLayer}setOnStateChange(e){this.onStateChange=e}async notifyStateChange(){this.onStateChange&&await this.onStateChange()}async changeGender(e){this.currentGender!==e&&(this.currentGender=e,this.currentState=f(this.currentGender),this.currentLayer=d[this.currentGender][0].name,this.updateURL(),await this.notifyStateChange())}setCurrentLayer(e){this.currentLayer=e}async updateLayerValue(e,t){this.currentState[e]=t,this.updateURL(),await this.notifyStateChange()}async randomize(){this.currentState=w(this.currentGender),this.updateURL(),await this.notifyStateChange()}updateURL(){const e=d[this.currentGender],t=[];e.forEach(n=>{t.push(this.currentState[n.name])});const r=t.join("-"),a=new URL(window.location.href);a.searchParams.set("gender",this.currentGender),a.searchParams.set("avatar",r),window.history.replaceState({},"",a.toString())}loadFromURL(){const e=new URL(window.location.href),t=e.searchParams.get("gender"),r=e.searchParams.get("avatar");if(t&&(t==="male"||t==="female")&&(this.currentGender=t,this.genderRadios.forEach(a=>{const n=a;n.checked=n.value===t})),r){const a=r.split("-").map(Number),n=d[this.currentGender];a.length===n.length&&n.forEach((s,c)=>{const i=a[c];i>=1&&i<=s.count&&(this.currentState[s.name]=i)})}}getShareURL(){return window.location.href}}class S{renderer;stateManager;genderRadios;layerTabs;layerContent;constructor(){this.renderer=new C("avatar-canvas","loading-indicator"),this.stateManager=new b("male"),this.genderRadios=document.querySelectorAll('input[name="gender"]'),this.layerTabs=document.querySelectorAll(".layer-tab"),this.layerContent=document.getElementById("layer-content"),this.stateManager.setOnStateChange(()=>this.onStateChange()),this.init()}async init(){this.setupEventListeners(),await this.renderer.preloadImages(this.stateManager.getGender()),this.renderLayerItems(),await this.renderer.renderAvatar(this.stateManager.getGender(),this.stateManager.getState())}setupEventListeners(){this.genderRadios.forEach(r=>{r.addEventListener("change",async a=>{const n=a.target;n.checked&&await this.changeGender(n.value)})}),this.layerTabs.forEach(r=>{r.addEventListener("click",()=>{const a=r.dataset.layer;a&&this.switchLayer(a)})}),document.getElementById("randomize-btn")?.addEventListener("click",()=>this.randomize()),document.getElementById("download-btn")?.addEventListener("click",()=>this.download())}getStateManager(){return this.stateManager}async onStateChange(){this.renderLayerItems(),await this.renderer.renderAvatar(this.stateManager.getGender(),this.stateManager.getState())}async changeGender(e){await this.renderer.preloadImages(e),await this.stateManager.changeGender(e),this.layerTabs.forEach((t,r)=>{t.classList.toggle("active",r===0)})}switchLayer(e){this.stateManager.setCurrentLayer(e),this.layerTabs.forEach(t=>{t.classList.remove("active"),t.dataset.layer===e&&t.classList.add("active")}),this.renderLayerItems()}renderLayerItems(){if(!this.layerContent)return;this.layerContent.innerHTML="";const e=this.stateManager.getGender(),t=this.stateManager.getCurrentLayer(),r=this.stateManager.getState(),a=d[e].find(n=>n.name===t);if(a)for(let n=1;n<=a.count;n++){const s=document.createElement("div");if(s.className="layer-item",s.style.cssText="aspect-ratio: 1; border: 1px solid transparent; border-radius: 0.15rem; cursor: pointer; transition: all 0.2s;",s.dataset.index=n.toString(),r[t]===n&&(s.classList.add("selected"),s.style.cssText+=" border-color: var(--pink, #dcb8b0); box-shadow: 0 0 0 1px var(--pink, #dcb8b0);"),t!=="background"){const i=this.renderer.renderThumbnail(e,a.name,n,r.background);i.style.cssText="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: pointer;",s.appendChild(i)}else{const i=document.createElement("img");i.style.cssText="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: pointer;";const l=h(e,a.name,n);i.src=l,i.alt=`${a.title} ${n}`,s.appendChild(i)}const c=document.createElement("span");c.className="layer-item-number",c.style.cssText="display: flex; flex-direction: column; align-items: center; transition: all 0.2s; font-family: uni0553; font-weight: 700;",c.textContent=n.toString(),s.appendChild(c),s.addEventListener("mouseenter",()=>{const i=s.style.borderColor;i!=="var(--pink, #dcb8b0)"&&i!=="rgb(220, 184, 176)"&&(s.style.borderColor="var(--blue, #9bb0cd)"),s.style.transform="scale(1.05)"}),s.addEventListener("mouseleave",()=>{s.classList.contains("selected")||(s.style.borderColor="transparent"),s.style.transform="scale(1)"}),s.addEventListener("click",async()=>{await this.stateManager.updateLayerValue(t,n)}),this.layerContent.appendChild(s)}}async randomize(){await this.stateManager.randomize()}download(){this.renderer.downloadAvatar("8biticon.png")}}let m=null;function I(){const o=document.getElementById("share-btn");if(!o||!m)return;v("avatar-share-notification"),o.replaceWith(o.cloneNode(!0)),document.getElementById("share-btn")?.addEventListener("click",async()=>{const t=m?.getStateManager().getShareURL();t&&await L(t,"avatar-share-notification")})}function y(){document.getElementById("avatar-canvas")&&(m=new S,I())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();document.addEventListener("astro:page-load",y);
