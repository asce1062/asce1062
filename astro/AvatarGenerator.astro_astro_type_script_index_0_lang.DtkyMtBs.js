const d={male:[{name:"face",title:"Face",count:4,zIndex:1},{name:"clothes",title:"Clothes",count:65,zIndex:2},{name:"hair",title:"Hair",count:36,zIndex:3},{name:"eye",title:"Eyes",count:32,zIndex:4},{name:"mouth",title:"Mouth",count:26,zIndex:5},{name:"background",title:"Background",count:21,zIndex:0}],female:[{name:"face",title:"Face",count:4,zIndex:1},{name:"clothes",title:"Clothes",count:59,zIndex:2},{name:"hair",title:"Hair",count:33,zIndex:3},{name:"eye",title:"Eyes",count:53,zIndex:4},{name:"mouth",title:"Mouth",count:17,zIndex:5},{name:"background",title:"Background",count:21,zIndex:0}]},h=(c,t,e)=>t==="background"?`/8bit/img/common/${t}${e}.png`:`/8bit/img/${c}/${t}${e}.png`,L=c=>{const t=d[c],e={};return t.forEach(i=>{e[i.name]=Math.floor(Math.random()*i.count)+1}),e},f=c=>{const t=d[c],e={},r={male:[3,54,12,14,15,21],female:[4,26,32,22,3,3]}[c];return t.forEach((a,n)=>{e[a.name]=r[n]}),e};class p{canvas;ctx;imageCache=new Map;loadingIndicator;isLoading=!1;constructor(t,e){const i=document.getElementById(t);if(!i)throw new Error(`Canvas with id "${t}" not found`);this.canvas=i;const r=this.canvas.getContext("2d");if(!r)throw new Error("Could not get 2D context from canvas");this.ctx=r,this.loadingIndicator=e?document.getElementById(e):null}async preloadImages(t){this.setLoading(!0);const e=d[t],i=[];for(const r of e)for(let a=1;a<=r.count;a++){const n=h(t,r.name,a);this.imageCache.has(n)||i.push(this.loadImage(n))}await Promise.all(i),this.setLoading(!1)}loadImage(t){return new Promise(e=>{const i=new Image;i.onload=()=>{this.imageCache.set(t,i),e()},i.onerror=()=>{console.error(`Failed to load image: ${t}`),e()},i.src=t})}getCachedImage(t){return this.imageCache.get(t)}async renderAvatar(t,e){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const r=[...d[t]].sort((a,n)=>a.zIndex-n.zIndex);for(const a of r){const n=e[a.name],o=h(t,a.name,n),s=this.imageCache.get(o);s&&s.complete&&this.ctx.drawImage(s,0,0,this.canvas.width,this.canvas.height)}}renderThumbnail(t,e,i,r,a=80,n=80){const o=document.createElement("canvas");o.width=a,o.height=n;const s=o.getContext("2d");if(e!=="background"){const y=h(t,"background",r),m=this.imageCache.get(y);m&&m.complete&&s.drawImage(m,0,0,a,n)}const l=h(t,e,i),u=this.imageCache.get(l);return u&&u.complete&&s.drawImage(u,0,0,a,n),o}downloadAvatar(t="8biticon.png"){this.canvas.toBlob(e=>{if(!e)return;const i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)},"image/png")}setLoading(t){this.isLoading=t,this.loadingIndicator&&this.loadingIndicator.classList.toggle("hidden",!t)}getIsLoading(){return this.isLoading}}class v{currentGender;currentState;currentLayer;genderRadios;onStateChange;constructor(t="male"){this.currentGender=t,this.currentState=f(this.currentGender),this.currentLayer=d[this.currentGender][0].name,this.genderRadios=document.querySelectorAll('input[name="gender"]'),this.loadFromURL()}getGender(){return this.currentGender}getState(){return this.currentState}getCurrentLayer(){return this.currentLayer}setOnStateChange(t){this.onStateChange=t}async notifyStateChange(){this.onStateChange&&await this.onStateChange()}async changeGender(t){this.currentGender!==t&&(this.currentGender=t,this.currentState=f(this.currentGender),this.currentLayer=d[this.currentGender][0].name,this.updateURL(),await this.notifyStateChange())}setCurrentLayer(t){this.currentLayer=t}async updateLayerValue(t,e){this.currentState[t]=e,this.updateURL(),await this.notifyStateChange()}async randomize(){this.currentState=L(this.currentGender),this.updateURL(),await this.notifyStateChange()}updateURL(){const t=d[this.currentGender],e=[];t.forEach(a=>{e.push(this.currentState[a.name])});const i=e.join("-"),r=new URL(window.location.href);r.searchParams.set("gender",this.currentGender),r.searchParams.set("avatar",i),window.history.replaceState({},"",r.toString())}loadFromURL(){const t=new URL(window.location.href),e=t.searchParams.get("gender"),i=t.searchParams.get("avatar");if(e&&(e==="male"||e==="female")&&(this.currentGender=e,this.genderRadios.forEach(r=>{const a=r;a.checked=a.value===e})),i){const r=i.split("-").map(Number),a=d[this.currentGender];r.length===a.length&&a.forEach((n,o)=>{const s=r[o];s>=1&&s<=n.count&&(this.currentState[n.name]=s)})}}getShareURL(){return window.location.href}}class w{renderer;stateManager;genderRadios;layerTabs;layerContent;shareNotification;notificationTimeout=null;constructor(){this.renderer=new p("avatar-canvas","loading-indicator"),this.stateManager=new v("male"),this.genderRadios=document.querySelectorAll('input[name="gender"]'),this.layerTabs=document.querySelectorAll(".layer-tab"),this.layerContent=document.getElementById("layer-content"),this.shareNotification=document.getElementById("share-notification"),this.stateManager.setOnStateChange(()=>this.onStateChange()),this.init()}async init(){this.setupEventListeners(),await this.renderer.preloadImages(this.stateManager.getGender()),this.renderLayerItems(),await this.renderer.renderAvatar(this.stateManager.getGender(),this.stateManager.getState())}setupEventListeners(){this.genderRadios.forEach(a=>{a.addEventListener("change",async n=>{const o=n.target;o.checked&&await this.changeGender(o.value)})}),this.layerTabs.forEach(a=>{a.addEventListener("click",()=>{const n=a.dataset.layer;n&&this.switchLayer(n)})}),document.getElementById("randomize-btn")?.addEventListener("click",()=>this.randomize()),document.getElementById("download-btn")?.addEventListener("click",()=>this.download()),document.getElementById("share-btn")?.addEventListener("click",()=>this.shareAvatar()),document.getElementById("close-notification")?.addEventListener("click",()=>this.hideNotification())}async onStateChange(){this.renderLayerItems(),await this.renderer.renderAvatar(this.stateManager.getGender(),this.stateManager.getState())}async changeGender(t){await this.renderer.preloadImages(t),await this.stateManager.changeGender(t),this.layerTabs.forEach((e,i)=>{e.classList.toggle("active",i===0)})}switchLayer(t){this.stateManager.setCurrentLayer(t),this.layerTabs.forEach(e=>{e.classList.remove("active"),e.dataset.layer===t&&e.classList.add("active")}),this.renderLayerItems()}renderLayerItems(){if(!this.layerContent)return;this.layerContent.innerHTML="";const t=this.stateManager.getGender(),e=this.stateManager.getCurrentLayer(),i=this.stateManager.getState(),r=d[t].find(a=>a.name===e);if(r)for(let a=1;a<=r.count;a++){const n=document.createElement("div");if(n.className="layer-item",n.style.cssText="aspect-ratio: 1; border: 1px solid transparent; border-radius: 0.15rem; cursor: pointer; transition: all 0.2s;",n.dataset.index=a.toString(),i[e]===a&&(n.classList.add("selected"),n.style.cssText+=" border-color: var(--pink, #dcb8b0); box-shadow: 0 0 0 1px var(--pink, #dcb8b0);"),e!=="background"){const s=this.renderer.renderThumbnail(t,r.name,a,i.background);s.style.cssText="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: pointer;",n.appendChild(s)}else{const s=document.createElement("img");s.style.cssText="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: pointer;";const l=h(t,r.name,a);s.src=l,s.alt=`${r.title} ${a}`,n.appendChild(s)}const o=document.createElement("span");o.className="layer-item-number",o.style.cssText="display: flex; flex-direction: column; align-items: center; transition: all 0.2s; font-family: uni0553; font-weight: 700;",o.textContent=a.toString(),n.appendChild(o),n.addEventListener("mouseenter",()=>{const s=n.style.borderColor;s!=="var(--pink, #dcb8b0)"&&s!=="rgb(220, 184, 176)"&&(n.style.borderColor="var(--blue, #9bb0cd)"),n.style.transform="scale(1.05)"}),n.addEventListener("mouseleave",()=>{n.classList.contains("selected")||(n.style.borderColor="transparent"),n.style.transform="scale(1)"}),n.addEventListener("click",async()=>{await this.stateManager.updateLayerValue(e,a)}),this.layerContent.appendChild(n)}}async randomize(){await this.stateManager.randomize()}download(){this.renderer.downloadAvatar("8biticon.png")}async shareAvatar(){try{const t=this.stateManager.getShareURL();await navigator.clipboard.writeText(t),this.showNotification()}catch(t){console.error("Failed to copy URL to clipboard:",t)}}showNotification(){this.shareNotification&&(this.notificationTimeout&&(clearTimeout(this.notificationTimeout),this.notificationTimeout=null),this.shareNotification.classList.remove("fadeOut","hidden"),this.notificationTimeout=window.setTimeout(()=>{this.hideNotification()},3e3))}hideNotification(){this.shareNotification&&(this.notificationTimeout&&(clearTimeout(this.notificationTimeout),this.notificationTimeout=null),this.shareNotification.classList.add("fadeOut"),setTimeout(()=>{this.shareNotification.classList.add("hidden"),this.shareNotification.classList.remove("fadeOut")},300))}}function g(){new w}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();document.addEventListener("astro:page-load",g);
