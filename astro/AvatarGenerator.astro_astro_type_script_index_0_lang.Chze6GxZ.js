const s={male:[{name:"face",title:"Face",count:4,zIndex:1},{name:"clothes",title:"Clothes",count:65,zIndex:2},{name:"hair",title:"Hair",count:36,zIndex:3},{name:"eye",title:"Eyes",count:32,zIndex:4},{name:"mouth",title:"Mouth",count:26,zIndex:5},{name:"background",title:"Background",count:21,zIndex:0}],female:[{name:"face",title:"Face",count:4,zIndex:1},{name:"clothes",title:"Clothes",count:59,zIndex:2},{name:"hair",title:"Hair",count:33,zIndex:3},{name:"eye",title:"Eyes",count:53,zIndex:4},{name:"mouth",title:"Mouth",count:17,zIndex:5},{name:"background",title:"Background",count:21,zIndex:0}]},h=(o,n,t)=>n==="background"?`/8bit/img/common/${n}${t}.png`:`/8bit/img/${o}/${n}${t}.png`,f=o=>{const n=s[o],t={};return n.forEach(e=>{t[e.name]=Math.floor(Math.random()*e.count)+1}),t},m=o=>{const n=s[o],t={},i={male:[3,54,12,14,15,21],female:[4,26,32,22,3,3]}[o];return n.forEach((a,r)=>{t[a.name]=i[r]}),t};class u{canvas;ctx;currentGender="male";currentState;currentLayer;imageCache=new Map;isLoading=!1;notificationTimeout=null;genderRadios;layerTabs;layerContent;loadingIndicator;shareNotification;constructor(){this.canvas=document.getElementById("avatar-canvas"),this.ctx=this.canvas.getContext("2d"),this.currentState=m(this.currentGender),this.currentLayer=s[this.currentGender][0].name,this.genderRadios=document.querySelectorAll('input[name="gender"]'),this.layerTabs=document.querySelectorAll(".layer-tab"),this.layerContent=document.getElementById("layer-content"),this.loadingIndicator=document.getElementById("loading-indicator"),this.shareNotification=document.getElementById("share-notification"),this.init()}async init(){this.setupEventListeners(),this.loadFromURL(),await this.preloadImages(),this.renderLayerItems(),await this.renderAvatar()}setupEventListeners(){this.genderRadios.forEach(a=>{a.addEventListener("change",r=>{const d=r.target;d.checked&&this.changeGender(d.value)})}),this.layerTabs.forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.layer;r&&this.switchLayer(r)})}),document.getElementById("randomize-btn")?.addEventListener("click",()=>this.randomize()),document.getElementById("download-btn")?.addEventListener("click",()=>this.download()),document.getElementById("share-btn")?.addEventListener("click",()=>this.shareAvatar()),document.getElementById("close-notification")?.addEventListener("click",()=>this.hideNotification())}switchLayer(n){this.currentLayer=n,this.layerTabs.forEach(t=>{t.classList.remove("active"),t.dataset.layer===n&&t.classList.add("active")}),this.renderLayerItems()}async preloadImages(){this.setLoading(!0);const n=s[this.currentGender],t=[];for(const e of n)for(let i=1;i<=e.count;i++){const a=h(this.currentGender,e.name,i);this.imageCache.has(a)||t.push(this.loadImage(a))}await Promise.all(t),this.setLoading(!1)}loadImage(n){return new Promise(t=>{const e=new Image;e.onload=()=>{this.imageCache.set(n,e),t()},e.onerror=()=>{console.error(`Failed to load image: ${n}`),t()},e.src=n})}renderLayerItems(){if(!this.layerContent)return;this.layerContent.innerHTML="";const n=s[this.currentGender].find(t=>t.name===this.currentLayer);if(n)for(let t=1;t<=n.count;t++){const e=document.createElement("div");if(e.className="layer-item",e.style.cssText="aspect-ratio: 1; border: 1px solid transparent; border-radius: 0.15rem; cursor: pointer; transition: all 0.2s;",e.dataset.index=t.toString(),this.currentState[this.currentLayer]===t&&(e.classList.add("selected"),e.style.cssText+=" border-color: var(--pink, #dcb8b0); box-shadow: 0 0 0 1px var(--pink, #dcb8b0);"),this.currentLayer!=="background"){const a=document.createElement("canvas");a.width=80,a.height=80,a.style.cssText="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: pointer;";const r=a.getContext("2d"),d=h(this.currentGender,"background",this.currentState.background),c=this.imageCache.get(d);c&&c.complete&&r.drawImage(c,0,0,a.width,a.height);const g=h(this.currentGender,n.name,t),l=this.imageCache.get(g);l&&l.complete&&r.drawImage(l,0,0,a.width,a.height),e.appendChild(a)}else{const a=document.createElement("img");a.style.cssText="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; cursor: pointer;";const r=h(this.currentGender,n.name,t);a.src=r,a.alt=`${n.title} ${t}`,e.appendChild(a)}const i=document.createElement("span");i.className="layer-item-number",i.style.cssText="display: flex; flex-direction: column; align-items: center; transition: all 0.2s;",i.textContent=t.toString(),e.appendChild(i),e.addEventListener("mouseenter",()=>{const a=e.style.borderColor;a!=="var(--pink, #dcb8b0)"&&a!=="rgb(220, 184, 176)"&&(e.style.borderColor="var(--blue, #9bb0cd)"),e.style.transform="scale(1.05)"}),e.addEventListener("mouseleave",()=>{e.classList.contains("selected")||(e.style.borderColor="transparent"),e.style.transform="scale(1)"}),e.addEventListener("click",async()=>{this.currentState[this.currentLayer]=t,this.renderLayerItems(),await this.renderAvatar(),this.updateURL()}),this.layerContent.appendChild(e)}}async renderAvatar(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const t=[...s[this.currentGender]].sort((e,i)=>e.zIndex-i.zIndex);for(const e of t){const i=this.currentState[e.name],a=h(this.currentGender,e.name,i),r=this.imageCache.get(a);r&&r.complete&&this.ctx.drawImage(r,0,0,this.canvas.width,this.canvas.height)}}async changeGender(n){this.currentGender!==n&&(this.currentGender=n,this.currentState=m(this.currentGender),this.currentLayer=s[this.currentGender][0].name,this.layerTabs.forEach((t,e)=>{t.classList.toggle("active",e===0)}),await this.preloadImages(),this.renderLayerItems(),await this.renderAvatar(),this.updateURL())}async randomize(){this.currentState=f(this.currentGender),this.renderLayerItems(),await this.renderAvatar(),this.updateURL()}download(){this.canvas.toBlob(n=>{if(!n)return;const t=URL.createObjectURL(n),e=document.createElement("a");e.href=t,e.download="8biticon.png",document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(t)},"image/png")}setLoading(n){this.isLoading=n,this.loadingIndicator&&this.loadingIndicator.classList.toggle("hidden",!n)}updateURL(){const n=s[this.currentGender],t=[];n.forEach(a=>{t.push(this.currentState[a.name])});const e=t.join("-"),i=new URL(window.location.href);i.searchParams.set("gender",this.currentGender),i.searchParams.set("avatar",e),window.history.replaceState({},"",i.toString())}loadFromURL(){const n=new URL(window.location.href),t=n.searchParams.get("gender"),e=n.searchParams.get("avatar");if(t&&(t==="male"||t==="female")&&(this.currentGender=t,this.genderRadios.forEach(i=>{const a=i;a.checked=a.value===t})),e){const i=e.split("-").map(Number),a=s[this.currentGender];i.length===a.length&&a.forEach((r,d)=>{const c=i[d];c>=1&&c<=r.count&&(this.currentState[r.name]=c)})}}async shareAvatar(){try{await navigator.clipboard.writeText(window.location.href),this.showNotification()}catch(n){console.error("Failed to copy URL to clipboard:",n)}}showNotification(){this.shareNotification&&(this.notificationTimeout&&(clearTimeout(this.notificationTimeout),this.notificationTimeout=null),this.shareNotification.classList.remove("fadeOut","hidden"),this.notificationTimeout=window.setTimeout(()=>{this.hideNotification()},3e3))}hideNotification(){this.shareNotification&&(this.notificationTimeout&&(clearTimeout(this.notificationTimeout),this.notificationTimeout=null),this.shareNotification.classList.add("fadeOut"),setTimeout(()=>{this.shareNotification.classList.add("hidden"),this.shareNotification.classList.remove("fadeOut")},300))}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new u):new u;
